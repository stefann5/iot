PI1 Smart Home System - Implementation Summary
=================================================

OVERVIEW:
Full IoT Smart Home system built on Raspberry Pi with Angular+PrimeNG frontend,
FastAPI backend, MQTT messaging, InfluxDB time-series storage, and Grafana visualization.

ARCHITECTURE:
  PI Device (main.py) --MQTT--> Mosquitto --MQTT--> FastAPI Server --> InfluxDB
                                                         |
                                                    WebSocket
                                                         |
                                                   Angular Frontend  <--iframe--> Grafana

==========================================================================
IMPLEMENTED FEATURES (1-10)
==========================================================================

FEATURE 1: DPIR1 motion -> DL on for 10 seconds
------------------------------------------------------------------------
- When DPIR1 detects motion, door light (DL/LED) turns on for 10 seconds.
- Timer resets if motion detected again within those 10 seconds.
- Implemented in: main.py -> on_pir1() callback + turn_on_led_timed()

FEATURE 2: Enter/Exit detection + People counting
------------------------------------------------------------------------
- When DPIR1 detects motion, DUS1 ultrasonic distance buffer is analyzed.
- Algorithm compares first-half vs second-half average distances over 5 seconds.
- Distance decreasing >10cm = person ENTERING, increasing >10cm = EXITING.
- 3-second cooldown between detections to avoid duplicates.
- Same logic applied to DPIR2 + DUS2 (feature 2a).
- People count maintained with minimum bound at 0.
- Implemented in: main.py -> PeopleCounter class + on_pir1()/on_pir2() callbacks

FEATURE 3: Door open >5 seconds triggers ALARM (unlocked door simulation)
------------------------------------------------------------------------
- When DS1 or DS2 reports door OPEN, a 5-second timer starts.
- If door is still open after 5 seconds, ALARM triggers from ANY state
  (DISARMED or ARMED) - simulates an unlocked/unattended door.
- If door closes within 5 seconds, timer is cancelled - no alarm.
- ALARM activates buzzer (DB) and LED (DL).
- Alarm reason is tracked and displayed on web dashboard.
- Deactivated by entering PIN on DMS (1234#) or via web app.
- Implemented in: main.py -> AlarmSystem.start_door_open_timer(),
  cancel_door_open_timer(), on_door_open_timeout()

FEATURE 4: DMS security alarm with delayed arming + PIN grace period
------------------------------------------------------------------------
- Pressing 'A' on DMS keypad starts 10-second arming countdown (ARMING state).
- After 10 seconds, system transitions to ARMED state.
- While ARMED, if DS1 or DS2 detects door open:
  - 10-second grace period starts for PIN entry on DMS.
  - If correct PIN (1234#) entered within grace period -> system disarms.
  - If no PIN entered in time -> ALARM triggers.
- Entering correct PIN deactivates from any state (ARMING, ARMED, ALARM).
- Web app arm button arms immediately (no delay).
- DMS keys: digits=PIN entry, #=submit PIN, *=clear, A=arm system.
- Implemented in: main.py -> AlarmSystem.arm(delayed=True), ARMING state,
  start_ds_grace_timer(), on_ds_grace_expired(), process_key()

FEATURE 5: Room PIR intruder detection when facility is empty
------------------------------------------------------------------------
- RPIR1 (Bedroom), RPIR2 (Master Bedroom), RPIR3 (Living Room) PIR sensors
  monitor for motion inside the facility.
- When people count (from feature 2) is 0 AND any RPIR detects motion:
  - ALARM triggers immediately from ANY state (DISARMED or ARMED).
  - Reason: intruder detected in empty facility.
- When people count > 0, RPIR motion does NOT trigger alarm.
- Web dashboard shows warning when people count = 0.
- Implemented in: main.py -> on_room_pir_motion(), RPIR1-3 sensor loops

FEATURE 6: GSG Gyroscope Alarm (Patron Saint Icon Protection)
------------------------------------------------------------------------
- GSG gyroscope sensor mounted on patron saint icon monitors for movement.
- When significant movement is detected (theft/tampering attempt):
  - ALARM triggers immediately from ANY state.
  - Alarm reason: "GSG gyroscope - significant movement on patron saint icon"
- Gyroscope outputs X, Y, Z acceleration values.
- Threshold for significant movement configurable in settings.json.
- Implemented in: main.py -> GSG sensor loop, on_gyroscope() callback

FEATURE 7: DHT1-3 Temperature/Humidity on LCD
------------------------------------------------------------------------
- Three DHT sensors monitor temperature and humidity:
  - DHT1: Bedroom
  - DHT2: Master Bedroom
  - DHT3: Kitchen
- LCD display in living room alternates between DHT readings every 5 seconds.
- Display format: Line 1: "Room: XXC", Line 2: "Humidity: XX%"
- All readings published via MQTT and visible on web dashboard.
- Implemented in: main.py -> DHT sensor loops, lcd_rotation_loop()

FEATURE 8: Kitchen Timer (4SD, BTN, Web Control)
------------------------------------------------------------------------
- 4SD (4-digit 7-segment display) shows countdown timer in MM:SS format.
- Kitchen BTN adds N seconds to timer (default: 10s, configurable via web).
- Timer controllable via web app:
  - Set timer duration (minutes)
  - Start/Stop timer
  - Add seconds
  - Configure BTN add amount
- When timer reaches 00:00:
  - 4SD display blinks 00:00
  - Pressing BTN stops blinking and resets display
- Timer state published via MQTT for real-time web updates.
- Implemented in: main.py -> KitchenTimer class, 4SD/BTN sensor loops

FEATURE 9: BRGB RGB LED Control via IR Remote and Web App
------------------------------------------------------------------------
- BRGB (Bedroom RGB LED) controllable via:
  - IR remote control (buttons 1-9 = colors, POWER = toggle, VOL = brightness)
  - Web application (color picker, preset buttons, brightness slider)
  - Console commands (rgb on/off, rgb COLOR, rgb R G B)
- IR receiver (PI3) decodes NEC protocol button presses.
- Supported colors: red, green, blue, yellow, cyan, magenta, white, orange, purple.
- Brightness adjustable 0-100% via web slider or IR VOL_UP/VOL_DOWN.
- Custom RGB values settable via web color picker.
- All state changes published via MQTT and visible on web dashboard.
- Implemented in: main.py -> BRGB + IR sensor initialization, on_ir_received(),
  MQTT command handler for pi1/commands/brgb

FEATURE 10: Webcam Video Display on Web Application
------------------------------------------------------------------------
- WEBC (Door Web Camera) streams live video to the web dashboard.
- Real hardware: OpenCV captures JPEG frames from USB webcam.
- Simulator: Generates BMP test pattern frames (color-cycling checkerboard).
- Server provides:
  - /api/webcam/stream - MJPEG stream endpoint (multipart/x-mixed-replace)
  - /api/webcam/frame - Single frame endpoint
  - /api/webcam/status - Camera status
- Web dashboard displays live feed in an img tag pointing to MJPEG stream.
- Implemented in: main.py -> webcam initialization,
  server/app.py -> webcam_stream(), get_webcam_frame()

ALARM SYSTEM:
------------------------------------------------------------------------
- States: DISARMED -> ARMING (10s delay) -> ARMED -> ALARM
- During ALARM: DB (buzzer) ON + DL (LED) ON
- All alarm events stored in InfluxDB and visible in Grafana.
- Web dashboard shows real-time notifications (toast) for state changes.
- Alarm reason tracked and displayed on dashboard.
- PIN: 1234 (configurable in settings.json)

==========================================================================
SENSORS AND ACTUATORS
==========================================================================

PI1 Sensors:
  DS1  - Door Sensor 1 (Button)         - Monitors door open/close
  DS2  - Door Sensor 2 (Button)         - Second door monitoring
  DL   - Door Light (LED)               - Auto-on with PIR, alarm indicator
  DUS1 - Door Ultrasonic Sensor 1       - Distance for enter/exit detection
  DUS2 - Door Ultrasonic Sensor 2       - Second door distance detection
  DB   - Door Buzzer                    - Alarm audio indicator
  DPIR1- Door PIR Motion Sensor 1       - Motion at door 1
  DPIR2- Door PIR Motion Sensor 2       - Motion at door 2
  DMS  - Door Membrane Switch (4x4)     - PIN entry, alarm control

Room PIR Sensors (Feature 5):
  RPIR1- Bedroom PIR Sensor             - Intruder detection
  RPIR2- Master Bedroom PIR Sensor      - Intruder detection
  RPIR3- Living Room PIR Sensor         - Intruder detection

Feature 6-8 Sensors/Actuators:
  GSG  - Gyroscope (Patron Saint Icon)  - Movement/theft detection
  DHT1 - Bedroom DHT                    - Temperature/humidity
  DHT2 - Master Bedroom DHT             - Temperature/humidity
  DHT3 - Kitchen DHT                    - Temperature/humidity
  LCD  - Living Room LCD Display        - Shows rotating DHT readings
  4SD  - Kitchen 4-Digit Display        - Timer countdown MM:SS
  BTN  - Kitchen Button                 - Adds time to timer

Feature 9-10 Sensors/Actuators:
  IR   - Bedroom IR Receiver            - Receives IR remote control commands
  BRGB - Bedroom RGB LED                - RGB LED bulb with color/brightness
  WEBC - Door Web Camera                - Video feed from door camera

All sensors configurable as simulated or real hardware via settings.json.

==========================================================================
WEB APPLICATION
==========================================================================

Frontend: Angular 17 + PrimeNG
  - Real-time sensor monitoring via WebSocket
  - Alarm control panel (Arm/Deactivate with PIN)
  - People counter with knob visualization
  - LED/Buzzer manual controls
  - Embedded Grafana dashboard (iframe)
  - Toast notifications for alarm events
  - Alarm reason display
  - ARMING state with blue pulse animation
  - Gyroscope (GSG) status panel with X/Y/Z readings (Feature 6)
  - DHT temperature/humidity readings for all 3 sensors (Feature 7)
  - Kitchen timer control panel with start/stop/set (Feature 8)
  - BRGB RGB light control: color picker, presets, brightness slider (Feature 9)
  - IR remote button activity display (Feature 9)
  - Live webcam video feed from MJPEG stream (Feature 10)

Backend: FastAPI
  - REST API: /api/status, /api/alarm/*, /api/people-count, /api/led, /api/buzzer, /api/timer
  - REST API: /api/brgb (GET/POST) - BRGB state and control (Feature 9)
  - REST API: /api/webcam/stream, /api/webcam/frame, /api/webcam/status (Feature 10)
  - WebSocket: /ws for real-time updates
  - MQTT subscriber -> InfluxDB writer
  - All sensor states tracked in memory + persisted to InfluxDB
  - Timer state management and MQTT commands

==========================================================================
MQTT TOPICS
==========================================================================

  pi1/sensors/button           - DS1, DS2 door state
  pi1/sensors/ultrasonic       - DUS1, DUS2 distance readings
  pi1/sensors/pir              - DPIR1, DPIR2, RPIR1-3 motion events
  pi1/sensors/membrane_switch  - DMS key presses
  pi1/actuators/led            - DL state changes
  pi1/actuators/buzzer         - DB state changes
  pi1/alarm/state              - Alarm state (0=disarmed, 1=alarm, 2=armed, 3=arming)
  pi1/alarm/event              - Alarm events (armed, arming, alarm_activated, etc.)
  pi1/alarm/reason             - Alarm trigger reason
  pi1/people/count             - Current people count
  pi1/people/event             - Direction (ENTERING/EXITING)
  pi1/commands/#               - Web app commands (alarm, led, buzzer, timer)
  pi1/sensors/gyroscope        - GSG gyroscope X/Y/Z readings (Feature 6)
  pi1/sensors/dht              - DHT1-3 temperature/humidity (Feature 7)
  pi1/actuators/lcd            - LCD display content (Feature 7)
  pi1/actuators/segment_display - 4SD display value (Feature 8)
  pi1/timer/state              - Timer state (remaining, running, blinking)
  pi1/timer/event              - Timer events (finished, blink_stopped)
  pi1/sensors/ir_receiver      - IR remote button presses (Feature 9)
  pi1/actuators/rgb_led        - BRGB RGB LED state (Feature 9)
  pi1/commands/brgb            - BRGB web commands (on/off/color/brightness)
  pi1/sensors/webcam           - Webcam status (Feature 10)

==========================================================================
HOW TO RUN
==========================================================================

1. Start infrastructure:    docker-compose up -d --build
2. Run PI device script:    python main.py
3. Access web dashboard:    http://localhost:4200
4. Access Grafana:          http://localhost:3000 (admin/admin)
5. Default alarm PIN:       1234

==========================================================================
FILES MODIFIED FOR FEATURES 3-5
==========================================================================

  main.py           - AlarmSystem: ARMING state, door open timers, grace timers,
                      trigger_alarm() from any state, callbacks.
                      PeopleCounter: multi-sensor distance buffers.
                      New sensors: DS2, DUS2, DPIR2, RPIR1-3 initialization.
  settings.json     - Added DS2, DUS2, DPIR2, RPIR1-3 configurations.
  server/app.py     - Added new sensors to state tracking, ARMING state support,
                      alarm reason handling.
  frontend/src/app/components/dashboard/dashboard.component.ts
                    - ARMING state handling, alarm reason tracking, notifications.
  frontend/src/app/components/dashboard/dashboard.component.html
                    - Alarm reason display, intruder detection warning, ARMING tag.
  frontend/src/app/components/dashboard/dashboard.component.scss
                    - ARMING blue pulse animation.

==========================================================================
FILES MODIFIED FOR FEATURES 6-8
==========================================================================

  simulators/gyroscope.py    - GSG gyroscope simulator with movement simulation.
  simulators/dht.py          - DHT temperature/humidity simulator.
  simulators/lcd.py          - LCD display simulator.
  simulators/segment_display.py - 4SD 7-segment display simulator.
  sensors/gyroscope.py       - Real gyroscope hardware driver.
  sensors/dht.py             - Real DHT hardware driver.
  sensors/lcd.py             - Real LCD I2C hardware driver.
  sensors/segment_display.py - Real 7-segment display driver.
  settings.json              - Added GSG, DHT1-3, LCD, 4SD, BTN configurations
                               and MQTT topics.
  main.py                    - KitchenTimer class, Feature 6-8 sensor loops,
                               LCD rotation thread, timer MQTT commands.
  server/app.py              - Added GSG, DHT, LCD, 4SD, BTN, TIMER states,
                               timer REST endpoints, MQTT topic handling.
  frontend/src/app/services/api.service.ts
                             - Timer API endpoints.
  frontend/src/app/components/dashboard/dashboard.component.ts
                             - Timer state, gyroscope display, DHT display helpers,
                               timer control methods.
  frontend/src/app/components/dashboard/dashboard.component.html
                             - Kitchen timer panel, GSG status panel, DHT readings.
  frontend/src/app/components/dashboard/dashboard.component.scss
                             - Timer blink animation.

==========================================================================
FILES MODIFIED/CREATED FOR FEATURES 9-10
==========================================================================

  simulators/ir_receiver.py    - IR remote control simulator with NEC codes.
  simulators/rgb_led.py        - BRGB RGB LED simulator with color/brightness.
  simulators/webcam.py         - Webcam simulator generating BMP test patterns.
  sensors/ir_receiver.py       - Real IR receiver GPIO hardware driver.
  sensors/rgb_led.py           - Real RGB LED PWM hardware driver.
  sensors/webcam.py            - Real webcam OpenCV capture driver.
  settings.json                - Added IR, BRGB, WEBC configurations and MQTT topics.
  main.py                      - Feature 9: IR receiver + BRGB initialization, IR->RGB
                                 action mapping, BRGB MQTT command handler.
                                 Feature 10: Webcam initialization and status publishing.
                                 Console: rgb on/off/COLOR commands.
  server/app.py                - Added IR, BRGB, WEBC states; BRGBRequest model;
                                 /api/brgb endpoints; /api/webcam/stream MJPEG endpoint;
                                 /api/webcam/frame and /api/webcam/status endpoints;
                                 brgb_state tracking in WebSocket broadcasts.
  frontend/src/app/services/api.service.ts
                               - BRGB API endpoints, webcam URL helpers.
  frontend/src/app/components/dashboard/dashboard.component.ts
                               - BRGB state tracking, IR button tracking, webcam stream URL,
                                 color picker handler, brightness controls, BRGB/IR/webcam
                                 display helpers.
  frontend/src/app/components/dashboard/dashboard.component.html
                               - BRGB control panel (color picker, presets, brightness
                                 slider, IR remote info), webcam live feed panel.

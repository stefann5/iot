<!-- Header Toolbar -->
<p-toolbar styleClass="mb-4">
  <div class="p-toolbar-group-start">
    <span class="text-2xl font-bold">
      <i class="pi pi-home mr-2"></i>PI1 Smart Home Dashboard
    </span>
  </div>
  <div class="p-toolbar-group-end">
    <p-tag
      [value]="alarmState"
      [severity]="getAlarmSeverity()"
      [styleClass]="alarmState === 'ALARM' ? 'alarm-active text-lg px-3 py-2' : alarmState === 'ARMING' ? 'arming-pulse text-lg px-3 py-2' : 'text-lg px-3 py-2'"
    ></p-tag>
    <span class="ml-3 text-sm" [class.text-green-400]="wsConnected" [class.text-red-400]="!wsConnected">
      <i class="pi" [class.pi-circle-fill]="wsConnected" [class.pi-circle]="!wsConnected"></i>
      {{ wsConnected ? 'Connected' : 'Disconnected' }}
    </span>
  </div>
</p-toolbar>

<div class="grid p-3">
  <!-- Alarm Control Panel -->
  <div class="col-12 lg:col-6">
    <p-panel header="Alarm Control" [toggleable]="true">
      <div class="flex align-items-center gap-4 flex-wrap">
        <div class="flex-grow-1">
          <p class="text-xl mb-2">
            Status:
            <p-tag [value]="alarmState" [severity]="getAlarmSeverity()" styleClass="text-lg px-3 py-1"></p-tag>
          </p>
          <p *ngIf="alarmReason" class="text-sm text-red-400 mt-1">
            <i class="pi pi-exclamation-triangle mr-1"></i>
            {{ alarmReason }}
          </p>
        </div>
        <div class="flex gap-2">
          <button
            pButton
            label="Arm System"
            icon="pi pi-shield"
            class="p-button-warning"
            (click)="armAlarm()"
            [disabled]="alarmState !== 'DISARMED'"
          ></button>
          <button
            pButton
            label="Deactivate"
            icon="pi pi-lock-open"
            class="p-button-success"
            (click)="showDeactivateDialog()"
            [disabled]="alarmState === 'DISARMED'"
          ></button>
        </div>
      </div>
      <p class="text-sm text-400 mt-2">
        When armed, door opening or motion will trigger the alarm.
        Enter PIN on the membrane switch or via this panel to deactivate.
      </p>
      <p class="text-sm text-400 mt-1">
        Door open for more than 5 seconds triggers alarm automatically.
        Room motion with 0 people inside also triggers alarm.
      </p>
    </p-panel>
  </div>

  <!-- People Counter -->
  <div class="col-12 lg:col-6">
    <p-panel header="People Inside" [toggleable]="true">
      <div class="flex align-items-center justify-content-center gap-4">
        <p-knob
          [(ngModel)]="peopleCount"
          [readonly]="true"
          [size]="120"
          [min]="0"
          [max]="20"
          valueColor="#22C55E"
          rangeColor="#334155"
        ></p-knob>
        <div>
          <p class="text-3xl font-bold mb-2">{{ peopleCount }}</p>
          <p class="text-400">people currently inside</p>
          <p *ngIf="lastDirection" class="mt-2">
            Last:
            <p-tag
              [value]="lastDirection"
              [severity]="lastDirection === 'ENTERING' ? 'success' : 'warning'"
            ></p-tag>
          </p>
          <p *ngIf="peopleCount === 0" class="mt-2 text-red-400 text-sm">
            <i class="pi pi-exclamation-circle mr-1"></i>
            Room PIR sensors active (intruder detection)
          </p>
        </div>
      </div>
    </p-panel>
  </div>

  <!-- Kitchen Timer (Feature 8) -->
  <div class="col-12 lg:col-6">
    <p-panel header="Kitchen Timer" [toggleable]="true">
      <div class="flex flex-column gap-3">
        <div class="flex align-items-center justify-content-center">
          <span class="text-5xl font-bold" [class.text-orange-400]="timerBlinking" [class.timer-blink]="timerBlinking">
            {{ timerDisplay }}
          </span>
        </div>
        <div class="flex align-items-center justify-content-center gap-2">
          <p-tag [value]="timerRunning ? 'RUNNING' : timerBlinking ? 'TIME UP!' : 'STOPPED'"
                 [severity]="timerRunning ? 'success' : timerBlinking ? 'warning' : 'info'"></p-tag>
        </div>
        <div class="flex align-items-center gap-2">
          <label class="w-6rem">Set Minutes:</label>
          <p-inputNumber [(ngModel)]="timerInputMinutes" [min]="1" [max]="99" [showButtons]="true"></p-inputNumber>
          <button pButton label="Set" icon="pi pi-check" class="p-button-sm" (click)="timerSetTime()"></button>
        </div>
        <div class="flex gap-2">
          <button pButton label="Start" icon="pi pi-play" class="p-button-success" (click)="timerStart()" [disabled]="timerRunning"></button>
          <button pButton label="Stop" icon="pi pi-stop" class="p-button-danger" (click)="timerStop()" [disabled]="!timerRunning"></button>
          <button pButton label="Add Time" icon="pi pi-plus" class="p-button-warning" (click)="timerAddSeconds()" [disabled]="timerBlinking"></button>
          <button *ngIf="timerBlinking" pButton label="Press BTN (Stop Blink)" icon="pi pi-bell-slash" class="p-button-info" (click)="timerPressBTN()"></button>
        </div>
        <div class="flex align-items-center gap-2">
          <label class="w-8rem">BTN adds (sec):</label>
          <p-inputNumber [(ngModel)]="timerBtnSeconds" [min]="1" [max]="60" [showButtons]="true"></p-inputNumber>
          <button pButton label="Save" icon="pi pi-save" class="p-button-sm p-button-secondary" (click)="timerUpdateBtnSeconds()"></button>
        </div>
        <p class="text-sm text-400">
          Press kitchen BTN to add time. When timer ends, 4SD display blinks 00:00.
        </p>
      </div>
    </p-panel>
  </div>

  <!-- Gyroscope Alert (Feature 6) -->
  <div class="col-12 lg:col-6">
    <p-panel header="Patron Saint Icon (GSG)" [toggleable]="true">
      <div class="flex align-items-center gap-4">
        <i class="pi pi-compass text-5xl" [class.text-red-500]="sensors['GSG']?.value?.significant" [class.text-green-500]="!sensors['GSG']?.value?.significant"></i>
        <div class="flex-grow-1">
          <p class="text-xl font-bold mb-2">
            <p-tag [value]="sensors['GSG']?.value?.significant ? 'MOVEMENT DETECTED!' : 'Stable'"
                   [severity]="sensors['GSG']?.value?.significant ? 'danger' : 'success'"></p-tag>
          </p>
          <p class="text-400">Gyroscope monitors icon for theft/tampering</p>
          <div class="flex gap-3 mt-2 text-sm">
            <span>X: {{ sensors['GSG']?.value?.x?.toFixed(2) || '0.00' }}</span>
            <span>Y: {{ sensors['GSG']?.value?.y?.toFixed(2) || '0.00' }}</span>
            <span>Z: {{ sensors['GSG']?.value?.z?.toFixed(2) || '9.80' }}</span>
          </div>
        </div>
      </div>
      <p class="text-sm text-400 mt-2">
        Significant movement triggers ALARM immediately (theft protection).
      </p>
    </p-panel>
  </div>

  <!-- DHT Readings (Feature 7) -->
  <div class="col-12 lg:col-6">
    <p-panel header="Temperature & Humidity (DHT)" [toggleable]="true">
      <div class="grid">
        <div class="col-4 text-center">
          <p class="font-bold mb-1">Bedroom</p>
          <p class="text-2xl text-blue-400">{{ sensors['DHT1']?.value?.temperature || 0 }}°C</p>
          <p class="text-sm text-400">{{ sensors['DHT1']?.value?.humidity || 0 }}% RH</p>
        </div>
        <div class="col-4 text-center">
          <p class="font-bold mb-1">Master Bed</p>
          <p class="text-2xl text-blue-400">{{ sensors['DHT2']?.value?.temperature || 0 }}°C</p>
          <p class="text-sm text-400">{{ sensors['DHT2']?.value?.humidity || 0 }}% RH</p>
        </div>
        <div class="col-4 text-center">
          <p class="font-bold mb-1">Kitchen</p>
          <p class="text-2xl text-blue-400">{{ sensors['DHT3']?.value?.temperature || 0 }}°C</p>
          <p class="text-sm text-400">{{ sensors['DHT3']?.value?.humidity || 0 }}% RH</p>
        </div>
      </div>
      <p class="text-sm text-400 mt-3">
        <i class="pi pi-desktop mr-1"></i>
        LCD Display: {{ sensors['LCD']?.value?.line1 || 'Idle' }} | {{ sensors['LCD']?.value?.line2 || '' }}
      </p>
    </p-panel>
  </div>

  <!-- BRGB RGB Light Control (Feature 9) -->
  <div class="col-12 lg:col-6">
    <p-panel header="Bedroom RGB Light (BRGB)" [toggleable]="true">
      <div class="flex flex-column gap-3">
        <div class="flex align-items-center gap-3">
          <div class="brgb-preview" [style.background-color]="brgbOn ? getBrgbColorStyle() : '#333'"
               style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid #555; transition: background-color 0.3s;">
          </div>
          <div class="flex-grow-1">
            <p class="text-xl font-bold mb-1">
              <p-tag [value]="brgbOn ? 'ON' : 'OFF'" [severity]="brgbOn ? 'warning' : 'info'"></p-tag>
            </p>
            <p class="text-sm text-400">RGB({{ brgbR }}, {{ brgbG }}, {{ brgbB }}) &#64; {{ brgbBrightness }}%</p>
          </div>
          <div class="flex gap-2">
            <button pButton icon="pi pi-power-off" [class]="brgbOn ? 'p-button-warning' : 'p-button-secondary'" (click)="brgbToggle()"></button>
          </div>
        </div>

        <!-- Color Presets -->
        <div>
          <label class="font-bold text-sm mb-2 block">Quick Colors:</label>
          <div class="flex gap-2 flex-wrap">
            <button pButton class="p-button-sm p-button-rounded" style="background-color: #ff0000; border-color: #ff0000;" (click)="brgbSetColor('red')" title="Red"></button>
            <button pButton class="p-button-sm p-button-rounded" style="background-color: #00ff00; border-color: #00ff00;" (click)="brgbSetColor('green')" title="Green"></button>
            <button pButton class="p-button-sm p-button-rounded" style="background-color: #0000ff; border-color: #0000ff;" (click)="brgbSetColor('blue')" title="Blue"></button>
            <button pButton class="p-button-sm p-button-rounded" style="background-color: #ffff00; border-color: #ffff00;" (click)="brgbSetColor('yellow')" title="Yellow"></button>
            <button pButton class="p-button-sm p-button-rounded" style="background-color: #00ffff; border-color: #00ffff;" (click)="brgbSetColor('cyan')" title="Cyan"></button>
            <button pButton class="p-button-sm p-button-rounded" style="background-color: #ff00ff; border-color: #ff00ff;" (click)="brgbSetColor('magenta')" title="Magenta"></button>
            <button pButton class="p-button-sm p-button-rounded" style="background-color: #ffffff; border-color: #aaa; color: #333;" (click)="brgbSetColor('white')" title="White"></button>
            <button pButton class="p-button-sm p-button-rounded" style="background-color: #ffa500; border-color: #ffa500;" (click)="brgbSetColor('orange')" title="Orange"></button>
            <button pButton class="p-button-sm p-button-rounded" style="background-color: #800080; border-color: #800080;" (click)="brgbSetColor('purple')" title="Purple"></button>
          </div>
        </div>

        <!-- Custom Color Picker -->
        <div class="flex align-items-center gap-3">
          <label class="font-bold text-sm">Custom Color:</label>
          <p-colorPicker [(ngModel)]="brgbColorHex" (onChange)="brgbOnColorPickerChange($event.value)"></p-colorPicker>
        </div>

        <!-- Brightness Slider -->
        <div class="">
          <label class="">Brightness:</label>
          <p-slider [(ngModel)]="brgbBrightness" [min]="0" [max]="100" class="w-56" (onSlideEnd)="brgbUpdateBrightness()"></p-slider>
        </div>

        <!-- IR Remote Info -->
        <div class="flex align-items-center gap-2 mt-1">
          <i class="pi pi-wifi text-sm"></i>
          <span class="text-sm text-400">
            IR Remote: {{ lastIrButton || 'Waiting...' }}
            <span *ngIf="lastIrAction"> &rarr; {{ lastIrAction }}</span>
          </span>
        </div>

        <p class="text-sm text-400">
          Control via IR remote (buttons 1-9 = colors, POWER = toggle, VOL = brightness) or web app.
        </p>
      </div>
    </p-panel>
  </div>

  <!-- Webcam Feed (Feature 10) -->
  <div class="col-12 lg:col-6">
    <p-panel header="Door Camera (WEBC)" [toggleable]="true">
      <div class="flex flex-column gap-2">
        <div class="webcam-container" style="text-align: center; background: #111; border-radius: 8px; padding: 4px; min-height: 240px;">
          <img [src]="webcamStreamUrl"
               alt="Webcam Feed"
               style="max-width: 100%; height: auto; border-radius: 6px;"
               onerror="this.alt='Webcam feed unavailable'"
          />
        </div>
        <div class="flex align-items-center justify-content-between">
          <p-tag [value]="webcamActive ? 'Camera Active' : 'Camera Inactive'"
                 [severity]="webcamActive ? 'success' : 'info'"></p-tag>
          <span class="text-sm text-400">
            <i class="pi pi-video mr-1"></i>
            Live video feed from door camera
          </span>
        </div>
      </div>
    </p-panel>
  </div>

  <!-- Sensor Status Cards -->
  <div class="col-12">
    <p-panel header="Sensor & Actuator Status" [toggleable]="true">
      <div class="grid">
        <div *ngFor="let key of objectKeys(sensors)" class="col-12 md:col-6 lg:col-4">
          <p-card [styleClass]="'h-full'">
            <ng-template pTemplate="header">
              <div class="flex align-items-center justify-content-between px-3 pt-3">
                <span class="font-bold text-lg">
                  <i [class]="getSensorIcon(sensors[key].type) + ' mr-2'"></i>
                  {{ key }}
                </span>
                <p-tag
                  [value]="getSensorDisplayValue(sensors[key])"
                  [severity]="getSensorSeverity(sensors[key])"
                ></p-tag>
              </div>
            </ng-template>
            <p class="text-400 mb-2">{{ sensors[key].name }}</p>

            <!-- LED Controls -->
            <div *ngIf="sensors[key].type === 'led'" class="flex gap-2 mt-2">
              <button pButton label="ON" icon="pi pi-sun" class="p-button-sm p-button-warning" (click)="controlLed('on')"></button>
              <button pButton label="OFF" icon="pi pi-moon" class="p-button-sm p-button-secondary" (click)="controlLed('off')"></button>
            </div>

            <!-- Buzzer Controls -->
            <div *ngIf="sensors[key].type === 'buzzer'" class="flex gap-2 mt-2">
              <button pButton label="ON" icon="pi pi-volume-up" class="p-button-sm p-button-danger" (click)="controlBuzzer('on')"></button>
              <button pButton label="OFF" icon="pi pi-volume-off" class="p-button-sm p-button-secondary" (click)="controlBuzzer('off')"></button>
              <button pButton label="Beep" icon="pi pi-bell" class="p-button-sm p-button-info" (click)="controlBuzzer('beep')"></button>
            </div>
          </p-card>
        </div>
      </div>
    </p-panel>
  </div>

  <!-- Grafana Dashboard -->
  <div class="col-12">
    <p-panel header="Grafana - Sensor Data" [toggleable]="true">
      <iframe
        [src]="grafanaUrl | safeUrl"
        width="100%"
        height="600"
        frameborder="0"
        style="border: 1px solid var(--surface-border); border-radius: 8px;"
      ></iframe>
    </p-panel>
  </div>
</div>

<!-- PIN Dialog -->
<p-dialog
  header="Enter PIN to Deactivate"
  [(visible)]="showPinDialog"
  [modal]="true"
  [style]="{ width: '350px' }"
>
  <div class="flex flex-column gap-3 mt-2">
    <span class="p-float-label">
      <p-password
        [(ngModel)]="pinInput"
        [feedback]="false"
        [toggleMask]="true"
        inputId="pin"
        styleClass="w-full"
      ></p-password>
      <label for="pin">PIN Code</label>
    </span>
  </div>
  <ng-template pTemplate="footer">
    <button pButton label="Cancel" icon="pi pi-times" class="p-button-text" (click)="showPinDialog = false"></button>
    <button pButton label="Deactivate" icon="pi pi-check" class="p-button-success" (click)="deactivateAlarm()"></button>
  </ng-template>
</p-dialog>
